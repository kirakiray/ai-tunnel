<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent</title>
    <script src="./ofa.js"></script>
  </head>
  <body>
    <div style="padding: 20px">
      <h2>Agent Configuration</h2>
      <div>
        <label for="lmstudio-port">LMStudio Port: </label>
        <input type="number" id="lmstudio-port" min="1" max="65535" />
      </div>
      <div style="margin-top: 10px">
        <label for="agent-address">Agent Address: </label>
        <input type="text" id="agent-address" style="width: 250px" />
      </div>
      <div style="margin-top: 10px">
        <label for="model-selector">Model: </label>
        <select id="model-selector" style="width: 250px">
          <option value="qwen3-4b-2507">qwen3-4b-2507 (default)</option>
        </select>
        <button id="refresh-models-btn" style="margin-left: 10px">
          Refresh Models
        </button>
      </div>
      <div style="margin-top: 10px">
        <button id="connect-btn">Save</button>
      </div>
      <div style="margin-top: 10px">
        <div id="connection-status" style="margin-bottom: 10px; padding: 10px; border-radius: 5px; display: none;">
          <strong>WebSocket Status:</strong> <span id="websocket-status">Disconnected</span>
        </div>
        <div id="lmstudio-status" style="margin-bottom: 10px; padding: 10px; border-radius: 5px; display: none;">
          <strong>LMStudio Status:</strong> <span id="lmstudio-status-text">Unknown</span>
        </div>
      </div>
      <div style="margin-top: 10px">
        <label for="llmstxt-file">LLMs.txt File: </label>
        <input type="file" id="llmstxt-file" accept=".txt" />
        <button id="upload-llmstxt-btn">Upload LLMs.txt</button>
        <button id="clear-llmstxt-btn" disabled>Clear LLMs.txt</button>
        <div id="llmstxt-status" style="margin-top: 5px; font-size: 14px"></div>
        <div
          style="
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
          "
        >
          <h4 style="margin-top: 0">LLMs.txt 功能说明:</h4>
          <p style="margin: 5px 0">
            • 上传包含知识库内容的 LLMs.txt 文件，作为 AI 的系统提示词
          </p>
          <p style="margin: 5px 0">
            • AI 将使用文件中的内容作为上下文来回答问题
          </p>
          <p style="margin: 5px 0">• 支持清除已上传的文件</p>
          <p style="margin: 5px 0; font-weight: bold">
            提示: 文件内容将作为 System Prompt 发送给 AI
          </p>
        </div>
      </div>
    </div>

    <script type="module">
      import Agent from "./agent.js";
      import { LMStudioClient } from "./lmstudio-client.js";

      const connectBtn = document.getElementById("connect-btn");
      const refreshModelsBtn = document.getElementById("refresh-models-btn");
      const uploadLlmstxtBtn = document.getElementById("upload-llmstxt-btn");
      const clearLlmstxtBtn = document.getElementById("clear-llmstxt-btn");
      const llmstxtFileInput = document.getElementById("llmstxt-file");
      const llmstxtStatus = document.getElementById("llmstxt-status");
      const connectionStatus = document.getElementById("connection-status");
      const websocketStatus = document.getElementById("websocket-status");
      const lmstudioStatus = document.getElementById("lmstudio-status");
      const lmstudioStatusText = document.getElementById("lmstudio-status-text");

      // 从 localStorage 加载保存的设置
      $("#lmstudio-port").value = localStorage.localPort || "1234";
      $("#agent-address").value =
        localStorage.agentAddress || `ws://${location.host}/agent`;
      const savedModel = localStorage.selectedModel || "qwen3-4b-2507";
      const savedSystemPrompt = localStorage.systemPrompt || "";

      // 页面加载完成后自动连接
      document.addEventListener("DOMContentLoaded", async () => {
        // 加载模型列表
        await loadModelList();

        // 设置选中的模型
        const modelSelector = document.getElementById("model-selector");
        if (modelSelector.querySelector(`option[value="${savedModel}"]`)) {
          modelSelector.value = savedModel;
        }

        // 检查是否已存在system prompt，如果存在则启用清除按钮
        if (savedSystemPrompt) {
          clearLlmstxtBtn.disabled = false;
          llmstxtStatus.textContent = "LLMs.txt file loaded";
          llmstxtStatus.style.color = "green";
        }

        // 自动连接
        connectAgent();
      });

      // 刷新模型列表
      refreshModelsBtn.addEventListener("click", async () => {
        const port = document.getElementById("lmstudio-port").value;
        await checkLMStudioStatus(port);
        await loadModelList();
      });

      // 上传 LLMs.txt 文件
      uploadLlmstxtBtn.addEventListener("click", () => {
        const file = llmstxtFileInput.files[0];
        if (!file) {
          llmstxtStatus.textContent = "请选择一个文件";
          llmstxtStatus.style.color = "red";
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          // 保存到 localStorage
          localStorage.systemPrompt = content;
          llmstxtStatus.textContent = "文件上传成功，内容已保存";
          llmstxtStatus.style.color = "green";
          // 启用清除按钮
          clearLlmstxtBtn.disabled = false;
        };
        reader.onerror = function () {
          llmstxtStatus.textContent = "文件读取失败";
          llmstxtStatus.style.color = "red";
        };
        reader.readAsText(file);
      });

      // 清除 LLMs.txt 文件
      clearLlmstxtBtn.addEventListener("click", () => {
        // 从 localStorage 中清除 system prompt
        localStorage.removeItem("systemPrompt");
        // 禁用清除按钮
        clearLlmstxtBtn.disabled = true;
        // 清空文件输入框
        llmstxtFileInput.value = "";
        // 更新状态显示
        llmstxtStatus.textContent = "LLMs.txt file cleared";
        llmstxtStatus.style.color = "blue";
      });

      // 保存设置并重新连接
      connectBtn.addEventListener("click", () => {
        // 保存设置到 localStorage
        localStorage.localPort = $("#lmstudio-port").value;
        localStorage.agentAddress = $("#agent-address").value;
        localStorage.selectedModel = $("#model-selector").value;

        // 重新连接
        connectAgent();
      });

      // 加载模型列表
      async function loadModelList() {
        const port = document.getElementById("lmstudio-port").value;
        checkLMStudioStatus(port);

        const client = new LMStudioClient(`http://localhost:${port}`);

        try {
          const modelsResponse = await client.models();
          const modelSelector = document.getElementById("model-selector");

          // 保存当前选中的值
          const currentValue = modelSelector.value;

          // 清空现有选项
          modelSelector.innerHTML = "";

          // 添加新选项
          if (modelsResponse.data && Array.isArray(modelsResponse.data)) {
            modelsResponse.data.forEach((model) => {
              const option = document.createElement("option");
              option.value = model.id;
              option.textContent = model.id;
              modelSelector.appendChild(option);
            });
          }

          // 如果之前有选中的值，尝试恢复
          if (modelSelector.querySelector(`option[value="${currentValue}"]`)) {
            modelSelector.value = currentValue;
          }
          
          // 更新 LMStudio 状态为可用
          lmstudioStatus.style.display = "block";
          lmstudioStatusText.textContent = "Available";
          lmstudioStatusText.style.color = "green";
        } catch (error) {
          console.error("获取模型列表失败:", error);
          // 更新 LMStudio 状态为不可用
          lmstudioStatus.style.display = "block";
          lmstudioStatusText.textContent = "Unavailable";
          lmstudioStatusText.style.color = "red";
        }
      }

      // 检查 LMStudio 状态
      async function checkLMStudioStatus(port) {
        lmstudioStatus.style.display = "block";
        lmstudioStatusText.textContent = "Checking...";
        lmstudioStatusText.style.color = "orange";

        const client = new LMStudioClient(`http://localhost:${port}`);

        try {
          await client.models();
          lmstudioStatusText.textContent = "Available";
          lmstudioStatusText.style.color = "green";
        } catch (error) {
          lmstudioStatusText.textContent = "Unavailable";
          lmstudioStatusText.style.color = "red";
        }
      }

      // 连接 Agent
      function connectAgent() {
        // 断开之前的连接（如果有的话）
        if (window.agent) {
          window.agent.disconnect();
        }

        // 显示连接状态区域
        connectionStatus.style.display = "block";
        websocketStatus.textContent = "Connecting...";
        websocketStatus.style.color = "orange";

        // 创建新的 agent 实例并连接
        const port = document.getElementById("lmstudio-port").value;
        const lmstudioOptions = [`http://localhost:${port}`];
        const systemPrompt = localStorage.getItem("systemPrompt") || "";
        
        // 检查 LMStudio 是否可用
        checkLMStudioStatus(port);

        window.agent = new Agent({
          lmstudioOptions,
          model: $("#model-selector").value,
          systemPrompt: systemPrompt,
        });
        
        // 保存原始的 connect 方法
        const originalConnect = window.agent.connect;
        
        // 重写 connect 方法以添加状态更新
        window.agent.connect = function(url) {
          // 调用原始 connect 方法
          originalConnect.call(this, url);
          
          // 添加连接状态处理
          if (this.ws) {
            const originalOnOpen = this.ws.onopen;
            this.ws.onopen = function(event) {
              // 更新 WebSocket 状态为已连接
              websocketStatus.textContent = "Connected";
              websocketStatus.style.color = "green";
              
              // 调用原始 onopen 回调
              if (originalOnOpen) originalOnOpen.call(this, event);
            };

            const originalOnClose = this.ws.onclose;
            this.ws.onclose = function(event) {
              // 更新 WebSocket 状态为已断开
              websocketStatus.textContent = "Disconnected";
              websocketStatus.style.color = "red";
              
              // 调用原始 onclose 回调
              if (originalOnClose) originalOnClose.call(this, event);
            };

            const originalOnError = this.ws.onerror;
            this.ws.onerror = function(event) {
              // 更新 WebSocket 状态为错误
              websocketStatus.textContent = "Connection Error";
              websocketStatus.style.color = "red";
              
              // 调用原始 onerror 回调
              if (originalOnError) originalOnError.call(this, event);
            };
          }
        };

        window.agent.connect($("#agent-address").value);
      }
    </script>
  </body>
</html>
